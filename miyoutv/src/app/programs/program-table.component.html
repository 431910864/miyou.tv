<!DOCTYPE html>
<!--
Copyright 2016-2018 Brazil Ltd.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<meta charset="UTF-8">
<ngx-loading-bar></ngx-loading-bar>
<div class="programs view-content mt-4">
    <div class="view-content-header mt-2 pt-4 bg-dark">
        <form class="row m-0" [formGroup]="form">
            <div class="col-12 col-sm-3 col-lg-2">
                <div class="input-group" title="表示データ" *ngIf="archiveEnabled">
                    <div class="input-group-prepend">
                        <label class="input-group-text bg-dark text-light" for="source">
                            <span class="fa fa-database"></span>
                        </label>
                    </div>
                    <select id="source" class="form-control bg-dark text-light" formControlName="source">
                        <option value="archive">番組表</option>
                        <option value="recorded">録画情報</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-8">
                <ul class="nav justify-content-center" [ngClass]="{'d-none': dates.length >= 2, 'd-sm-flex': dates.length <= 3, 'd-md-flex': dates.length <= 5, 'd-lg-flex': dates.length <= 8}">
                    <li class="nav-item" *ngFor="let date of dates">
                        <a  class="nav-link" href="" [routerLink]="[]" [queryParams]="{date: (date | date:'y-M-d')}" routerLinkActive="active">{{date | date:'M/d EEE'}}</a>
                    </li>
                </ul>
                <div [ngClass]="{'d-none': dates.length < 2, 'd-sm-none': dates.length <= 3, 'd-md-none': dates.length <= 5, 'd-lg-none': dates.length <= 8}">
                    <div class="input-group">
                        <input class="form-control bg-dark text-light text-center" type="text" formControlName="date" #dp="bsDatepicker" bsDatepicker [bsConfig]="dpConfig" [minDate]="minDate" [maxDate]="maxDate" [placeholder]="this.currentDate | date:'y/M/d EEE'">
                        <div class="input-group-append" title="日付を選択">
                            <button class="btn btn-outline-light bg-dark text-light" type="button" (click)="dp.toggle()">
                            <span class="fa fa-calendar"></span>
                        </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-3 col-lg-2">
                <div class="dropdown text-right" dropdown [autoClose]="false">
                    <button class="dropdown-toggle btn btn-outline-light bg-dark text-light" dropdownToggle>
                        番組カテゴリ
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right bg-dark" *dropdownMenu>
                        <li class="dropdown-item p-0 bg-dark text-light" [title]="category.name" *ngFor="let category of categoryTable; let i = index" formArrayName="categories">
                            <div class="form-check px-2">
                                <input type="checkbox" [id]="category.codeName" [formControlName]="i">
                                <label class="form-check-label" [for]="category.codeName">{{category.name}}</label>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </form>
    </div>
    <div class="view-content-body scrollable" (scroll)="onScroll($event)" #viewport>
        <div class="program-header program-header-horizontal" [style.top]="scrollY + 'px'">
            <div class="program-header-cell" *ngFor="let channel of data">
                <div class="program-header-content clickable" title="チャンネルで検索" (click)="search('type:' + channel.type + ' ch:' + channel.channel)">
                    {{channel.channelName}}
                </div>
            </div>
        </div>
        <div class="program-header program-header-vertical" [style.left]="scrollX + 'px'">
            <div class="program-header-cell" *ngFor="let hour of hours" [style.height]="baseHeight + 'px'" [style.lineHeight]="baseHeight + 'px'">
                <div class="program-header-content">{{hour | dateEx:hourFirst:hourFormat:'HHH'}}</div>
            </div>
        </div>
        <div class="program-table">
            <div class="program-table-column" *ngFor="let column of data" [style.height]="baseHeight * 24 + 'px'" (dblclick)="playColumn($event, column)">
                <div class="program-table-cell" *ngFor="let item of column.programs" [class.d-none]="activeCategories.length > 0 && activeCategories.indexOf(item.category.code) === -1" [style.top]="item.top + 'px'" [style.height]="selectedItem === item ? 'auto' : item.height + 'px'" [style.minHeight]="item.height + 'px'" [style.maxHeight]="item.maxHeight + 'px'">
                    <div class="program-table-content selectable" [class.selected]="selectedItem === item" (click)="select(item)" (dblclick)="play(item); false" (mouseenter)="item.showPreview = true">
                        <span class="badge badge-balloon" *ngIf="countMode !== 'none'" [title]="'コメント数: ' + (item.commentCount | async) + '\n勢い： ' + (item.commentSpeed | async | number:'1.1-1') + '/分'">
                            {{countMode === 'speed' ? (item.commentSpeed | async | number:'1.1-1') : (item.commentCount | async)}}
                        </span>
                        <span class="time">{{item.start | dateEx:hourFirst:hourFormat:'AHHHH:mm'}}</span>
                        <span class="title quick-search quick-search-hidden">
                            {{item.fullTitle}}
                            <span class="fa fa-search quick-search-btn" title="番組名で検索" (click)="search(item.title)"></span>
                        </span>
                        <a class="badge" title="カテゴリで検索" [ngClass]="'badge-' + item.category.codeName" (click)="search('cat:' + item.category.codeName)">
                            {{item.category.name}}
                        </a>
                        <div class="detail">{{item.detail}}</div>
                        <div class="preview text-center" *ngIf="previewEnabled && item.showPreview">
                            <img width="160" height="90" *ngIf="(item.preview | async) || false" [src]="item.preview | async">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <form class="form-play">
        <button class="btn btn-play" type="button" title="選択した番組を再生" click="play()">再生</button>
    </form>
</div>
